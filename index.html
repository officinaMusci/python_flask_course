<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Python Course</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/black.css">

        <style>
            body {
                cursor: url(media/cursor.png), auto;
            }
            a {
                font-size: 15px;
                margin: auto 0 0 auto;
            }
            li {
                font-size: 20px;
                margin-bottom: 20px;
            }
            .container {
                display: flex;
            }
            .col {
                flex: 1;
            }

            .column-list {
                columns: 100px;
            }
        </style>

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/monokai.css">
    </head>

    <body>
        <div class="reveal">
            <div class="slides">

        <section>

            <section>

                <p>Flask</p>
            </section>


            <section>

                <p><small>
                    Flask est un micro framework web Ã©crit en Python ;<br>
                    voici ses principales caractÃ©ristiques :
                </small></p>

                <ul>
                    <li>Ultra lÃ©ger</li>
                    <li>Rapide Ã  apprendre et Ã  utiliser</li>
                    <li>
                        <strong>Dynamique :</strong><br>
                        <em>permet de crÃ©er des simples pages HTML et des REST API complexes</em>
                    </li>
                    <li>
                        <strong>Flexible :</strong><br>
                        <em>il peut Ãªtre Ã©tendu via des librairies et des modules</em>
                    </li>
                    <li>Maintenu par une grande communautÃ© de dÃ©veloppeurs</li>
                </ul>
            </section>


            <section>

                <p><small>Qui utilise Flask ?</small></p>

                <ul>
                    <li>Netflix</li>
                    <li>Reddit</li>
                    <li>AirBnB</li>
                    <li>Lyft</li>
                    <li>Mozilla</li>
                    <li>Uber</li>
                    <li><em>BientÃ´t vous aussi</em></li>
                </ul>
            </section>


            <section>
            <h3>La mise en place</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-6|8-15'>
        
        
                '''Fichier "app.py" Ã  la racine du projet'''
                # 1. On importe le module Flask
                import flask

                # 2. On dÃ©clare la variable globale pour l'application
                app = flask.Flask(__name__)

                # 3. On lance le serveur en mode dev pour avoir le debug
                &gt;&gt;&gt; export FLASK_ENV=development
                &gt;&gt;&gt; flask run

                # 3.b Si on utilise un fichier diffÃ©rent (hello.py) :
                &gt;&gt;&gt; export FLASK_ENV=development
                &gt;&gt;&gt; export FLASK_APP=hello
                &gt;&gt;&gt; flask run

        
                    </code></pre>
            </section>


            <section>
            <h3>Les routes</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='4-7|9-15|17-20|22-25|27-30'>
        
        
                import flask
                app = flask.Flask(__name__)

                # Une route est exposÃ©e par ce dÃ©corateur :
                @app.route('/endpoint', methods=['GET', 'POST'])
                def my_endpoint():
                    '''ðŸ¤–'''

                # Si plusieurs routes doivent pointer vers le mÃªme output
                @app.route('/')
                @app.route('/home', methods=['GET', 'POST'])
                @app.route('/index')
                @app.route('/index-post', methods=['POST'])
                def home():
                    '''ðŸ¤–'''

                # La route peut passer des arguments Ã  la fonction
                @app.route('/books/&lt;title&gt;')
                def books(title):
                    '''ðŸ¤–'''

                # ... prÃ©ciser les types
                @app.route('/articles/&lt;int:year&gt;/&lt;int:month&gt;')
                def articles(year, month):
                    '''ðŸ¤–'''

                # Et la fonction peut en dÃ©finir les dÃ©fauts
                @app.route('/reviews/&lt;int:year&gt;/&lt;int:month&gt;/&lt;str:title&gt;')
                def reviews(year=2021, month=12, title=None):
                    '''ðŸ¤–'''

        
                    </code></pre>
            </section>


            <section>
            <h3>L'objet requÃªte</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-3|7-17'>
        
        
                # Pour avoir accÃ¨s au request object, on doit l'importer
                import flask
                from flask import request # ðŸ†•

                app = flask.Flask(__name__)

                # Dans les routes on a acces au request object :
                @app.route('/endpoint')
                def endpoint():
                    request.method  # POST, GET, PUT, DELETE
                    request.args    # Les paramÃ©tres URL (?k=v)
                    request.headers # Les en-tÃªtes de la requÃªte

                    # Data reÃ§ues
                    request.form       # Le contenu du form (si submitted)
                    request.data       # Les data en format byte
                    request.get_json() # Les data lues depuis le JSON
    
        
                    </code></pre>
            </section>


            <section>
            <h3>Les rÃ©ponses</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='6-17|19-29|31-38|40-41'>
        
        
                import flask
                app = flask.Flask(__name__)

                @app.route('/')
                def home():
                    # A. Gabarit HTML
                    html = flask.render_template(
                        'index.html',
                        title='Bienvenue sur ma page web !',
                        visits=10
                    )

                    response = flask.make_response(
                        html,                  # body
                        200,                   # status
                        {'X-Foo': 'blah blah'} # headers
                    )

                    # B. RÃ©ponse JSON
                    json = flask.jsonify({
                        'results': [1, 2, 3],
                        'error': None
                    })

                    response = flask.make_response(
                        json,                                 # body
                        200,                                  # status
                        {'Content-Type': 'application/json'}  # headers
                    )

                    # C. RÃ©direction
                    response = flask.redirect(
                        flask.url_for(
                            'dashboard', # Nom de la fonction
                            visits=11    # /?visits=11 || /&amp;#60;visits=11&amp;#62;
                        ),
                        code=302
                    )

                    # On retourne la rÃ©ponse
                    return response
        
                    </code></pre>
            </section>


            <section>
                <p>C'est le temps de fabriquer quelque chose !</p>

                <p><small>CrÃ©ez une application Â« squelettique Â» qui servira de base aux prochaines Ã©tapes.</small></p>
                <p><small>Cette application doit avoir les routes pour les opÃ©rations suivantes :</small></p>

                <ul>
                    <li>Enregistrer un article</li>
                    <li>Modifier un article</li>
                    <li>Lister tous les articles</li>
                </ul>

                <p><small>Pour les rÃ©ponses, vous pouvez utiliser la mÃ©thode JSON et renvoyer des messages positifs pour les opÃ©rations effectuÃ©es, mÃªme si rien ne se passe rÃ©ellement !</small></p>
            </section>


            <section>
            <h3>La gestion des erreurs</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='4-16'>
        
        
                import flask
                app = flask.Flask(__name__)

                '''
                Des rÃ©ponses spÃ©cifiques peuvent Ãªtre retournÃ©es
                dans le cas oÃ¹ une requÃªte renvoie une erreur
                '''
                @app.errorhandler(404)
                def not_found():
                    '''ðŸ¤–'''

                @app.errorhandler(400)
                def bad_request():
                    '''ðŸ¤–'''

                @app.errorhandler(500)
                def server_error():
                    '''ðŸ¤–'''
        
                    </code></pre>
            </section>

        </section>


        <section>

            <section>
                <p>Le plan du projet</p>

                <p><small>Jusqu'Ã  prÃ©sent, c'Ã©taient les basesâ€¦
                <br>â€¦ c'est le moment de se compliquer la vie !
                <br>C'est ici que nous irons bientÃ´t :</small></p>

                <pre>
                project/
                â”œâ”€â”€ __init__.py
                â”œâ”€â”€ database/
                â”‚   â”œâ”€â”€ db.py
                â”‚   â””â”€â”€ schema.sql
                â”œâ”€â”€ routes/
                â”‚   â”œâ”€â”€ auth.py
                â”‚   â””â”€â”€ articles.py
                â”œâ”€â”€ templates/
                â”‚   â”œâ”€â”€ base.html
                â”‚   â”œâ”€â”€ auth/
                â”‚   â”‚   â”œâ”€â”€ login.html
                â”‚   â”‚   â””â”€â”€ register.html
                â”‚   â””â”€â”€ articles/
                â”‚       â”œâ”€â”€ create.html
                â”‚       â”œâ”€â”€ index.html
                â”‚       â””â”€â”€ update.html
                â””â”€â”€ static/ style.css
                </pre>
            </section>


            <section>
            <h3>La fabrique de l'app</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-7|9-22'>
        
        
                # ./__init__.py

                import os
                import flask

                def create_app():
                    app = flask.Flask(__name__)

                    # Configuration de l'app
                    app.config.from_mapping(
                        SECRET_KEY='utilisÃ©e_pour_le_cryptage',
                        DATABASE=os.path.join(
                            os.path.dirname(os.path.realpath(__file__)),
                            'database',
                            'project.sqlite'
                        ) # GÃ©nÃ¨re la path pour la BDD
                    )

                    # Ici on mettra nos routes
                    ...

                    return app
        
                    </code></pre>
            </section>


            <section>
            <h3>Le blueprint</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-11|14-20'>
        
        
                # ./routes/articles.py
                import flask
                blueprint = flask.Blueprint(
                    'articles',             # Nom
                    __name__,               # Nom pour l'import
                    url_prefix='/articles'
                )

                @blueprint.route('/new') # == '/articles/new'
                def new_article():
                    '''ðŸ¤–'''


                # ./__init__.py
                def create_app():
                    ...
                    # On peut ajouter nos routes sous forme de blueprints
                    from routes import articles # ðŸ†•
                    app.register_blueprint(articles.blueprint) # ðŸ†•
                    ...
        
                    </code></pre>
            </section>


            <section>
                <p>C'est parti !
                <br><small>Reconvertissez la structure du projet</small></p>

                <p><small>Puis crÃ©ez le blueprint "auth" avec les routes suivantes :</small></p>

                <ul>
                    <li>S'enregistrer</li>
                    <li>Effectuer le login</li>
                </ul>

                <p><small>Pour les rÃ©ponses, vous pouvez utiliser la mÃ©thode JSON et renvoyer des messages positifs pour les opÃ©rations effectuÃ©es, mÃªme si rien ne se passe rÃ©ellement !</small></p>
            </section>


            <section>
            <h3>La base de donnÃ©es</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-5|8-16|19-23|27-44|48-57|60-65|68-70|74-80'>
        
        
                #./database/db.py
                import sqlite3
                import click
                import flask
                from flask.cli import with_appcontext


                def get_db():
                    if 'db' not in flask.g: # "g" est la var de session
                        flask.g.db = sqlite3.connect(
                            flask.current_app.config['DATABASE'],
                            detect_types=sqlite3.PARSE_DECLTYPES
                        )
                        flask.g.db.row_factory = sqlite3.Row

                    return flask.g.db


                def close_db(e=None):
                    db = flask.g.pop('db', None) # DÃ©tache la BDD

                    if db is not None:
                        db.close()



                #./database/schema.sql
                DROP TABLE IF EXISTS user;
                DROP TABLE IF EXISTS article;

                CREATE TABLE user (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  username TEXT UNIQUE NOT NULL,
                  password TEXT NOT NULL
                );

                CREATE TABLE article (
                  id INTEGER PRIMARY KEY AUTOINCREMENT,
                  author_id INTEGER NOT NULL,
                  created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                  title TEXT NOT NULL,
                  body TEXT NOT NULL,
                  FOREIGN KEY (author_id) REFERENCES user (id)
                );



                #./database/db.py
                def init_db():
                    db = get_db()

                    with flask.current_app.open_resource(
                        'database/schema.sql'
                    ) as schema:
                        db.executescript(
                            schema.read().decode('utf8')
                        )


                @click.command('init-db') # $ flask init-db
                @with_appcontext
                def init_db_command():
                    """Efface et rÃ©crÃ©e la BDD"""
                    init_db()
                    click.echo('BDD initialisÃ©e')


                def init_app(app):
                    app.teardown_appcontext(close_db)
                    app.cli.add_command(init_db_command)



                #./__init__.py
                def create_app():
                    ...
                    # On peut initialiser la BDD dans la factory
                    from database import db
                    db.init_app(app)
                    ...
        
                    </code></pre>
            </section>


            <section>
            <h3>Le gabarit HTML de base</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='1|3-12|18-24|25-32|37-45'>
        
        
                &lt;!-- ./templates/base.html --&gt;
                &lt;!doctype html&gt;
                &lt;head&gt;
                  &lt;title&gt;{% block title %}{% endblock %} - Flaskr&lt;/title&gt;
                  &lt;link 
                    rel="stylesheet"
                    href="{{url_for(
                      'static',
                      filename='style.css'
                    ) }}"
                  &gt;
                &lt;/head&gt;

                &lt;body&gt;
                  &lt;nav&gt;
                    &lt;h1&gt;Flaskr&lt;/h1&gt;
                    &lt;ul&gt;
                      {% if g.user %}
                        &lt;li&gt;&lt;span&gt;
                          {{ g.user['username'] }}
                        &lt;/span&gt;&lt;/li&gt;
                        &lt;li&gt;&lt;a href="{{ url_for('auth.logout') }}"&gt;
                          Log Out
                        &lt;/a&gt;&lt;/li&gt;
                      {% else %}
                        &lt;li&gt;&lt;a href="{{ url_for('auth.register') }}"&gt;
                          Register
                        &lt;/a&gt;&lt;/li&gt;
                        &lt;li&gt;&lt;a href="{{ url_for('auth.login') }}"&gt;
                          Log In
                        &lt;/a&gt;&lt;/li&gt;
                      {% endif %}
                    &lt;/ul&gt;
                  &lt;/nav&gt;

                  &lt;section class="content"&gt;
                    &lt;header&gt;
                      {% block header %}{% endblock %}
                    &lt;/header&gt;

                    {% for message in get_flashed_messages() %}
                      &lt;div class="flash"&gt;{{ message }}&lt;/div&gt;
                    {% endfor %}

                    {% block content %}{% endblock %}
                  &lt;/section&gt;
                &lt;/body&gt;
        
                    </code></pre>
            </section>


            <section>
            <h3>Le formulaire d'enregistrement</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='3|5-7|9-19'>
        
        
                &lt;!-- ./templates/auth/register.html --&gt;

                {% extends 'base.html' %}

                {% block header %}
                  &lt;h1&gt;{% block title %}Register{% endblock %}&lt;/h1&gt;
                {% endblock %}

                {% block content %}
                  &lt;form method="post"&gt;
                    &lt;label&gt;Username
                      &lt;input name="username" required&gt;
                    &lt;/label&gt;
                    &lt;label&gt;Password
                      &lt;input type="password" name="password" required&gt;
                    &lt;/label&gt;
                    &lt;input type="submit" value="Register"&gt;
                  &lt;/form&gt;
                {% endblock %}
        
                    </code></pre>
            </section>


            <section>
            <h3>Le formulaire de login</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='3|5-7|9-19'>
        
        
                &lt;!-- ./templates/auth/login.html --&gt;

                {% extends 'base.html' %}

                {% block header %}
                  &lt;h1&gt;{% block title %}Log In{% endblock %}&lt;/h1&gt;
                {% endblock %}

                {% block content %}
                  &lt;form method="post"&gt;
                    &lt;label&gt;Username
                      &lt;input name="username" required&gt;
                    &lt;/label&gt;
                    &lt;label&gt;Password
                      &lt;input type="password" name="password" required&gt;
                    &lt;/label&gt;
                    &lt;input type="submit" value="Log In"&gt;
                  &lt;/form&gt;
                {% endblock %}
        
                    </code></pre>
            </section>

        </section>


        <section>

            <section>
            <h3>L'authentification</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-6|9-14|17-22|24-26|28-36|38-52|54-56|58-62|64-65|67-71|74-79|81-83|85-90|92-100|102-111|113-114|116-120|123-127|129-131|133-138|141-147|150-153|155-157|159-164|166-168|170-171|173-177|181-186'>
        
        
                # ./routes/auth.py
                import functools
                import flask
                from werkzeug import security

                from database.db import get_db


                # On dÃ©clare notre BP
                blueprint = flask.Blueprint(
                    'auth',
                    __name__,
                    url_prefix='/auth'
                )


                # Route pour le form d'enregistrement et son submit
                @blueprint.route('/register', methods=['GET', 'POST'])
                def register():

                    # Si "POST", il s'agit du submit
                    if flask.request.method == 'POST':
        
                        # 1. On rÃ©cupÃ¨re les data
                        username = flask.request.form['username']
                        password = flask.request.form['password']
        
                        # 2. On contrÃ´le les data
                        error = None
                        if not username:
                            error = 'Le nom utilisateur est requis'
                        elif not password:
                            error = 'Le mot de passe est requis'

                        # On continue seulement si les data sont lÃ 
                        if error is None:

                            # 3. On ouvre la BDD et on enregistre l'user
                            db = get_db()
                            try:
                                db.execute(
                                    "INSERT INTO user\
                                        (username, password)\
                                        VALUES (?, ?)",
                                    (
                                        username,
                                        security.generate_password_hash(
                                            password
                                        )
                                    ),
                                )
                                db.commit()

                            # 3.b On ajoute une erreur si il existe dÃ©jÃ 
                            except db.IntegrityError:
                                error = f"{username} existe dÃ©jÃ "

                            #Â 4. Si tout va bien, on rÃ©vient au login
                            else:
                                return flask.redirect(
                                    flask.url_for("auth.login")
                                )

                        # 5. Sinon, on ajoute l'erreur au flash bag
                        flask.flash(error)

                    # On affiche le form si "GET"
                    # ou si on a des erreurs Ã  afficher
                    return flask.render_template(
                        'auth/register.html'
                    )


                # Route pour le form de login et son submit
                @blueprint.route('/login', methods=['GET', 'POST'])
                def login():

                    # Si "POST", il s'agit du submit
                    if flask.request.method == 'POST':
            
                        # 1. On rÃ©cupÃ¨re les data
                        username = flask.request.form['username']
                        password = flask.request.form['password']

                        # 2. On ouvre la BDD et on cherche l'user
                        db = get_db()
                        user = db.execute(
                            'SELECT * FROM user WHERE username = ?',
                            (username,)
                        ).fetchone()

                        # 3. On contrÃ´le les data
                        error = None
                        if (
                            user is None or not security.check_password_hash(
                                user['password'],
                                password
                            )
                        ):
                            error = 'Identifiants non valides'

                        #Â 4. Si tout va bien, on nettoye la session,
                        # on enregistre l'user (id) en session
                        # et va Ã  l'index
                        if error is None:
                            flask.session.clear()
                            flask.session['user_id'] = user['id']
            
                            return flask.redirect(
                                flask.url_for('index')
                            )

                        # 5. Sinon, on ajoute l'erreur au flash bag
                        flask.flash(error)
    
                    # On affiche le form si "GET"
                    # ou si on a des erreurs Ã  afficher
                    return flask.render_template(
                        'auth/login.html'
                    )


                # On crÃ©e l'objet user pour chaque request
                @blueprint.before_app_request
                def load_logged_in_user():
                    # 1. On rÃ©cupÃ¨re l'ID depuis la session
                    user_id = flask.session.get('user_id')

                    # 2.a Si il n'existe pas, ce sera None
                    if user_id is None:
                        flask.g.user = None

                    # 2.b Si il existe, on le rÃ©cupÃ¨re depuis la BDD
                    else:
                        flask.g.user = get_db().execute(
                            'SELECT * FROM user WHERE id = ?',
                            (user_id,)
                        ).fetchone()


                # Au logout, on nettoye et on redirige
                @blueprint.route('/logout')
                def logout():
                    flask.session.clear()
                    return flask.redirect(
                        flask.url_for('index')
                    )


                # ðŸ†• Notre premier dÃ©corateur !
                # ici on en crÃ©e un pour protÃ©ger les pages

                def login_required(view):           # (view = la fonction)
    
                    @functools.wraps(view)          # On l'enveloppe
                    def wrapped_view(**kwargs):     # avec une function
                                                    # qui prend les kwargs

                        # Si la view est ouverte par un user
                        # non logguÃ©, on le redirige ver le login
                        if flask.g.user is None:
                            return flask.redirect(
                                flask.url_for('auth.login')
                            )

                        # Sinon on lance la bonne fonction
                        # avec ses kwargs originaux
                        return view(**kwargs)

                    # On retourne la fonction enveloppÃ©e
                    return wrapped_view

                # Et voilÃ  comment ce sera utilisÃ©
                @blueprint.route('/profile')
                @login_required # ðŸ†•
                def profile():
                    '''ðŸ¤–'''



                # ./__init__.py
                def create_app():
                    ...
                    from routes import auth
                    app.register_blueprint(auth.blueprint)
                    ...
        
                    </code></pre>
            </section>


            <section>
                <p>C'est parti !
                <br><small>On remet la main Ã  la pÃ¢te</small></p>

                <p><small>L'authentication</small></p>
                <ol>
                    <li>Ajoutez les fonctions d'auth</li>
                    <li>Ajoutez les templates HTML d'auth</li>
                    <li>Ajoutez le dÃ©corateur de protection aux views des articles</li>
                </ol>

                <p><small><em><a href="#/10/9">Structure du projet</a></em></small></p>
            </section>


            <section>
            <h3>La base de donnÃ©es II</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1-6|10-20|22-26|29-35|37-39|41-47|49-57|59-62|64-65|67-71|74-85|87-97|99-100|103-113|115-117|119-125|127-134|136-139|141-142|144-149|152-162|164-167'>
        
        
                # ./routes/articles.py
                import flask
                from werkzeug import exceptions

                from . import auth
                from database.db import get_db

                ...

                # La route pour afficher tous les articles
                @blueprint.route('/')
                def index():
                    db = get_db()
                    articles = db.execute(
                        'SELECT p.id, title, body, created,\
                            author_id, username'
                        ' FROM article p JOIN user u\
                            ON p.author_id = u.id'
                        ' ORDER BY created DESC'
                    ).fetchall()

                    # On affiche le template avec les articles
                    return flask.render_template(
                        'articles/index.html',
                        articles=articles
                    )


                # La route pour crÃ©er un nouvel article
                @blueprint.route('/create', methods=['GET', 'POST'])
                @auth.login_required
                def create():

                    # Si "POST", il s'agit du submit
                    if flask.request.method == 'POST':

                        # 1. On rÃ©cupÃ¨re les data
                        title = flask.request.form['title']
                        body = flask.request.form['body']
        
                        # 2. On contrÃ´le les data
                        error = None
                        if not title:
                            error = 'Le titre est requis'

                        # On continue seulement si les data sont lÃ 
                        if error is None:

                            # 3. On ouvre la BDD et on enregistre l'art.
                            db = get_db()
                            db.execute(
                                'INSERT INTO article\
                                    (title, body, author_id)'
                                ' VALUES (?, ?, ?)',
                                (title, body, flask.g.user['id'])
                            )
                            db.commit()

                            #Â 4. Si tout va bien, on rÃ©vient Ã  la liste
                            return flask.redirect(
                                flask.url_for('articles.index')
                            )

                        # 5. Sinon, on ajoute l'erreur au flash bag
                        flask.flash(error)

                    # On affiche le form si "GET"
                    # ou si on a des erreurs Ã  afficher
                    return flask.render_template(
                        'articles/create.html'
                    )


                # On crÃ©e un "helper" pour obtenir un article
                # Cela nous servira pour "update" et "delete"
                def get_article(id, check_author=True):
                    article = get_db().execute(
                        'SELECT\
                            p.id, title, body, created,\
                            author_id, username'
                        ' FROM article p JOIN user u\
                            ON p.author_id = u.id'
                        ' WHERE p.id=?',
                        (id,)
                    ).fetchone()

                    # On peut lever des erreurs HTTP
                    if article is None:
                        exceptions.abort(
                            404,
                            f"l'article {id} n'existe pas"
                        )
    
                    if check_author and (
                        article['author_id'] != flask.g.user['id']
                    ):
                        exceptions.abort(403)

                    # Si tout est ok, on retourne l'article
                    return article


                # La route pour mettre Ã  jour un article
                @blueprint.route(
                    '/&lt;int:id&gt;/update',
                    methods=['GET', 'POST']
                )
                @auth.login_required
                def update(id):
                    article = get_article(id)

                    # Si "POST", il s'agit du submit
                    if flask.request.method == 'POST':

                        # 1. On rÃ©cupÃ¨re les data
                        title = flask.request.form['title']
                        body = flask.request.form['body']
        
                        # 2. On contrÃ´le les data
                        error = None
                        if not title:
                            error = 'Title is required.'

                        # On continue seulement si les data sont lÃ 
                        if error is None:

                            # 3. On ouvre la BDD et on enregistre l'art.
                            db = get_db()
                            db.execute(
                                'UPDATE article SET title=?, body=?'
                                ' WHERE id=?',
                                (title, body, id)
                            )
                            db.commit()
            
                            #Â 4. Si tout va bien, on rÃ©vient Ã  la liste
                            return flask.redirect(
                                flask.url_for('articles.index')
                            )            

                        # 5. Sinon, on ajoute l'erreur au flash bag
                        flask.flash(error)

                    # On affiche le form si "GET"
                    # ou si on a des erreurs Ã  afficher
                    return flask.render_template(
                        'articles/edit.html',
                        article=article
                    )


                # La route pour effacer un article
                @blueprint.route('/&lt;int:id&gt;/delete', methods=['POST'])
                @auth.login_required
                def delete(id):
                    get_article(id)
                    db = get_db()
                    db.execute(
                        'DELETE FROM article WHERE id=?',
                        (id,)
                    )
                    db.commit()

                    # On rÃ©vient Ã  la liste
                    return flask.redirect(
                        flask.url_for('articles.index')
                    )
        
                    </code></pre>
            </section>


            <section>
            <h3>La liste des articles</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='1-2|4-12|14-16|18-24|25-33|36|39-43'>
        
        
                &lt;!-- ./templates/articles/index.html --&gt;
                {% extends 'base.html' %}

                {% block header %}
                  &lt;h1&gt;{% block title %}Articles{% endblock %}&lt;/h1&gt;
                  {% if g.user %}
                    &lt;a class="action"
                    href="{{ url_for('articles.create') }}"&gt;
                      Nouveau
                    &lt;/a&gt;
                  {% endif %}
                {% endblock %}

                {% block content %}
                  {% for article in articles %}
                    &lt;article class="article"&gt;
                      &lt;header&gt;
                        &lt;div&gt;
                          &lt;h1&gt;{{ article['title'] }}&lt;/h1&gt;
                          &lt;div class="about"&gt;
                            par {{ article['username'] }},
                            le {{article['created'].strftime('%Y-%m-%d')}}
                          &lt;/div&gt;
                        &lt;/div&gt;
                        {% if g.user['id'] == article['author_id'] %}
                          &lt;a class="action"
                          href="{{
                            url_for('articles.update',
                            id=article['id'])
                          }}"&gt;
                            Modifier
                          &lt;/a&gt;
                        {% endif %}
                      &lt;/header&gt;
      
                      &lt;p class="body"&gt;{{ article['body'] }}&lt;/p&gt;
                    &lt;/article&gt;
    
                    {% if not loop.last %}
                      &lt;hr&gt;
                    {% endif %}
                  {% endfor %}
                {% endblock %}
        
                    </code></pre>
            </section>


            <section>
            <h3>Le form de crÃ©ation</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='1-2|4-6|8-9|10-14|16-20|22|23-24'>
        
        
                &lt;!-- ./templates/articles/create.html --&gt;
                {% extends 'base.html' %}

                {% block header %}
                  &lt;h1&gt;{% block title %}Nouvel article{% endblock %}&lt;/h1&gt;
                {% endblock %}

                {% block content %}
                  &lt;form method="post"&gt;
                    &lt;label&gt;Titre
                      &lt;input name="title"
                      value="{{ request.form['title'] }}"
                      required&gt;
                    &lt;/label&gt;
    
                    &lt;label&gt;Contenu
                      &lt;textarea name="body"&gt;
                        {{ request.form['body'] }}
                      &lt;/textarea&gt;
                    &lt;/label&gt;
    
                    &lt;input type="submit" value="Save"&gt;
                  &lt;/form&gt;
                {% endblock %}
        
                    </code></pre>
            </section>


            <section>
            <h3>La form de Ã©dition</h3>
            <pre><code class='language-html'             data-trim data-noescape             data-line-numbers='1-2|4-8|10-11|12-18|20-27|29|34-38|40-41|42-43'>
        
        
                &lt;!-- ./templates/articles/edit.html --&gt;
                {% extends 'base.html' %}

                {% block header %}
                  &lt;h1&gt;{% block title %}
                    Modifier "{{ article['title'] }}"
                  {% endblock %}&lt;/h1&gt;
                {% endblock %}

                {% block content %}
                  &lt;form method="post"&gt;
                    &lt;label&gt;Titre
                    &lt;input name="title"
                      value="{{
                        request.form['title']
                        or article['title']
                      }}" required&gt;
                    &lt;/label&gt;

                    &lt;label&gt;Contenu
                      &lt;textarea name="body"&gt;
                          {{
                            request.form['body']
                            or article['body']
                          }}
                        &lt;/textarea&gt;
                    &lt;/label&gt;

                    &lt;input type="submit" value="Save"&gt;
                  &lt;/form&gt;
  
                  &lt;hr&gt;

                  &lt;form action="{{
                      url_for(
                        'articles.delete',
                        id=article['id'])
                    }}" method="post"&gt;
    
                    &lt;input class="danger" type="submit" value="Delete"
                    onclick="return confirm('Vous Ãªtes sÃ»r ?');"&gt;
                  &lt;/form&gt;
                {% endblock %}
        
                    </code></pre>
            </section>


            <section>
                <p>C'est le tour des articles !</p>

                <p><small>Les articles</small></p>
                <ol>
                    <li>Ajoutez les fonctions des views des articles</li>
                    <li>Ajoutez les templates HTML pour les articles</li>
                </ol>

                <p><small><em><a href="#/10/9">Structure du projet</a></em></small></p>
            </section>

        </section>


        <section>

            <section>

                <p>Flask II</p>
            </section>


            <section>
            <h3>Les JSON Web Tokens</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1|5-17|21-27|30-35|38-40|42-45|47-52|54-65|67-75|77-82|85-89|90-95|97-105'>
        
        
                # $ pip install flask-jwt-extended



                # ./__init__.py
                ...
                import flask_jwt_extended as flask_jwt
                ...
                def create_app():
                    ...
                    app.config.from_mapping(
                        ...
                        JWT_SECRET_KEY='utilisÃ©e_pour_le_cryptage_jwt'
                        ...
                    )
                    jwt = flask_jwt.JWTManager(app)
                    ...



                # ./routes/api.py ðŸ†•
                import flask
                from werkzeug import security

                import flask_jwt_extended as flask_jwt

                from database.db import get_db


                # On dÃ©clare le blueprint
                blueprint = flask.Blueprint(
                    'api',
                    __name__,
                    url_prefix='/api'
                )


                # Route pour le login
                @blueprint.route('/login', methods=['POST'])
                def login():

                    # 1. On rÃ©cupÃ¨re les data
                    request = flask.request.get_json()
                    username = request['username']
                    password = request['password']

                    # 2. On ouvre la BDD et on cherche l'user
                    db = get_db()
                    user = db.execute(
                        'SELECT * FROM user WHERE username = ?',
                        (username,)
                    ).fetchone()

                    # 3. On contrÃ´le les data
                    # 3.a Identifiants non valides
                    if (
                        user is None or not flask.check_password_hash(
                            user['password'],
                            password
                        )
                    ):
                        response = flask.jsonify({
                            'error': 'Identifiants non valides'
                        })
                        code = 401
    
                    # 3.b Identifiants valides, on crÃ©e un JWT
                    else:
                        access_token = flask_jwt.create_access_token(
                            identity=user['id']
                        )
                        response = flask.jsonify({
                            'access_token': access_token
                        })
                        code = 200

                    # 4. On envoi la rÃ©ponse
                    return flask.make_response(
                        response,
                        code,
                        {'Content-Type': 'application/json'}
                    )


                # Exemple de route protÃ©gÃ©e
                @blueprint.route('/protected')
                @flask_jwt.jwt_required() # On protÃ¨ge la route, notre
                def protected():          # requÃªte devra avoir en header :
                                          # {Authorization: "Bearer $JWT"}
                    # 1. On rÃ©cupÃ¨re le user
                    user_id = flask_jwt.get_jwt_identity()
                    user = get_db().execute(
                        'SELECT * FROM user WHERE id = ?',
                        (user_id,)
                    ).fetchone()
    
                    # 2. Pour dÃ©mo, on retourne le username
                    response = flask.jsonify({
                        'logged_in_as': user['username']
                    })
                    return flask.make_response(
                        response,
                        200,
                        {'Content-Type': 'application/json'}
                    )


        
                    </code></pre>
            </section>


            <section>
                <p>... AÃ¯e aÃ¯e aÃ¯e...
                <br><small>nous avons deux problÃ¨mes trÃ¨s typiques</small></p>

                <ul>
                    <li>Les routes ont trop de responsabilitÃ©s</li>
                    <li>Certains morceaux de code se rÃ©pÃ¨tent</li>
                </ul>

                <p><small>Il faut rÃ©soudre avant d'avoir une <strong>machine de Goldberg !</strong>
                <br>Essayez de mettre toute la logique dans des fonctions rÃ©utilisables.
                <br>Les routes ne doivent contenir que des routes !
                <br>Vous devrez arriver Ã  rÃ©organiser le tout comme Ã§a :</small></p>

                <pre>
                project/
                â”œâ”€â”€ services/
                â”‚   â”œâ”€â”€ auth.py (vÃ©rifier, chercher, encrypter, etc...)
                â”‚   â””â”€â”€ database/
                â”‚       â”œâ”€â”€ db.py (chercher, modifier, effacer, etc...)
                â”‚       â””â”€â”€ schema.sql
                â”œâ”€â”€ routes/
                â”‚   â”œâ”€â”€ auth.py
                â”‚   â””â”€â”€ articles.py
                ...
                </pre>
            </section>


            <section>
            <h3>Le fichier .env</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1|5-9|13-16|18-27'>
        
        
                # $ pip install python-dotenv



                # ./.env ðŸ†• (Ã  ajouter au .gitignore)

                SECRET_KEY='utilisÃ©e_pour_le_cryptage'
                JWT_SECRET_KEY='utilisÃ©e_pour_le_cryptage_jwt'
                ENV='development'



                # ./__init__.py
                ...
                import os
                from dotenv import load_dotenv

                def create_app():
                    load_dotenv()
                    ...
                    app.config.from_mapping(
                        ENV=os.getenv('ENV'),
                        SECRET_KEY=os.getenv('SECRET_KEY'),
                        JWT_SECRET_KEY=os.getenv('JWT_SECRET_KEY'),
                        ...
                    )
                    ...
        
                    </code></pre>
            </section>


            <section>
            <h3>Rendre l'app installable</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1|5|8-19|23-29|33-37'>
        
        
                # ./setup.py



                from setuptools import find_packages, setup


                setup(
                    name='project',
                    version='1.0.0',
                    packages=find_packages(),
                    include_package_data=True,
                    zip_safe=False,
                    install_requires=[
                        'flask',
                        'python-dotenv',
                        'flask-jwt-extended'
                    ],
                )



                # ./MANIFEST.in
                # Ici on dÃ©clare les fichiers
                # statiques Ã  importer
                include services/database/schema.sql
                graft static
                graft templates
                global-exclude *.pyc



                # On installe, global ou env
                # $ pip install -e .

                # Maintenant, flask run fonctionne
                # partout dans la machine
        
                    </code></pre>
            </section>

        </section>


        <section>

            <section>
            <h3>Les emails de confirmation</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1|5-14|18-20|22-25|27-33|35-36|40-47|51-53|56-58|60-63|65-69|72-74|76-79|81-87|89-91|93-94|98-99|102-106|108-109|111-115|117-122|124-128|130-137|139-142|144-147|150-155|157-160|162-167|169-173|175-176|178-179|181-186'>
        
        
                # $ pip install Flask-Mail



                # ./__init__.py
                ...
                def create_app():
                    ...
                    app.config.from_mapping(
                        ...
                        MAIL_DEFAULT_SENDER='gatekeeper@website.web'
                        SECURITY_PASSWORD_SALT='utilisÃ©e_pour_le_cryptage_token'
                        ...
                    )



                # ./services/email.py ðŸ†•
                import flask
                import flask_mail

                # On crÃ©e un helper pour envoyer les emails
                def send_email(to, subject, body):
                    app = flask.current_app
                    mail = flask_mail.Mail(app)
    
                    # 1. On compose le message avec les args
                    message = flask_mail.Message(
                        subject,
                        recipients=[to],
                        html=body,
                        sender=app.config['MAIL_DEFAULT_SENDER']
                    )
    
                    # On envoie le message
                    mail.send(message)



                #./services/database/schema.sql
                # On met Ã  jour le schema SQL
                ...
                CREATE TABLE user (
                  ...
                  email TEXT UNIQUE NOT NULL,
                  confirmed INTEGER(1) DEFAULT 0
                );



                #./services/auth.py
                import flask
                from itsdangerous import URLSafeTimedSerializer


                # On crÃ©e un helper pour gÃ©nÃ©rer les tokens
                def generate_confirmation_token(email):
                    app = flask.current_app

                    # 1. On initialise le serializer
                    serializer = URLSafeTimedSerializer(
                        app.config['SECRET_KEY']
                    )
    
                    # 2. On encrypte l'email
                    return serializer.dumps(
                        email,
                        salt=app.config['SECURITY_PASSWORD_SALT']
                    )


                # On crÃ©e un helper pour confirmer les tokens 
                def confirm_token(token, expiration=3600):
                    app = flask.current_app

                    # 1. On initialise le serializer
                    serializer = URLSafeTimedSerializer(
                        app.config['SECRET_KEY']
                    )
    
                    # 2. On essaye de dÃ©crypter
                    try:
                        email = serializer.loads(
                            token,
                            salt=app.config['SECURITY_PASSWORD_SALT'],
                            max_age=expiration
                        )
    
                    # 3.a On retourne False en cas de Ã©chec
                    except:
                        return False
    
                    # 3.b Si tout va bien, on retourne l'email
                    return email



                #./routes/auth.py
                from services import email


                # Route pour vÃ©rifier un token
                @blueprint.route('/confirm/&lt;token&gt;')
                @auth.login_required
                def confirm_token(token):
                    db = get_db()

                    # 1. On essaye de dÃ©crypter
                    email = auth.confirm_token(token)

                    # 2.a En cas d'echÃ©c
                    if not email:
                        flask.flash(
                            'Le lien de confirmation est invalide ou a expirÃ©'
                        )

                    # 2.b En cas de succÃ©s
                    else:
                        user = db.execute(
                            'SELECT * FROM user WHERE email=?',
                            (email,)
                        ).fetchone()
        
                        # 3.a Si l'user est confirmÃ© dÃ©jÃ 
                        if user.confirmed:
                            flask.flash(
                                'Compte dÃ©jÃ  confirmÃ©. Veuillez vous connecter.'
                            )
        
                        # 3.b Tout va bien, on met Ã  jour et on remercie
                        else:
                            db.execute(
                                'UPDATE user SET confirmed=1'
                                ' WHERE id=?',
                                (user['id'],)
                            )
                            db.commit()
            
                            flask.flash(
                                'You have confirmed your account. Thanks!',
                                'success'
                            )
    
                    # En tout cas, on redirige vers le login
                    return flask.redirect(
                        flask.url_for('auth.login')
                    )


                # On met Ã  jour la route d'enregistrement
                @blueprint.route('/register', methods=['GET', 'POST'])
                def register():
                    ...
                    # Dans l'Ã©tape 4.
                    else:
                        # 1. On crÃ©e un token
                        token = auth.generate_confirmation_token(
                            email
                        )

                        # 2. On crÃ©e le URL de confirmation
                        confirm_url = flask.url_for(
                            'auth.confirm_email',
                            token=token,
                            _external=True
                        )

                        # 3. On crÃ©e un message
                        email_body = f'''
                            &lt;p&gt;Veuillez suivre ce lien pour activer votre compte :&lt;/p&gt;
                            &lt;p&gt;&lt;a href="{confirm_url}"&gt;{confirm_url}&lt;/a&gt;&lt;/p&gt;
                        '''

                        # 4. On ajoute un objet
                        subject = 'Veuillez confirmer votre email'

                        # 5. On enoie l'email
                        email.send_email(email, subject, email_body)

                        # 6. On communique au front end
                        flask.flash(
                            'A confirmation email has been sent via email',
                            'success'
                        )
                        ...
        
                    </code></pre>
            </section>


            <section>
            <h3>Le ORM SQLAlchemy</h3>
            <pre><code class='language-python'             data-trim data-noescape             data-line-numbers='1|5-13|16-17|20-33|37-44|47-55|58-65|67-76|78-86|88-96|98-107'>
        
        
                # $ pip install sqlalchemy



                # ./services/database/db.py
                import os

                from dotenv import load_dotenv
                from sqlalchemy import create_engine
                from sqlalchemy.orm import sessionmaker
                from sqlalchemy.ext.declarative import declarative_base

                load_dotenv()


                # On dÃ©clare le type de DB
                Base = declarative_base()


                # On crÃ©e l'helper pour les sessions DB
                def create_session(engine=None):
                    engine = create_engine(
                        engine
                        or os.getenv('DB_ENGINE')
                        # f"sqlite:///{db_path}"
                    )
    
                    Base.metadata.create_all(engine)
                    Base.metadata.bind = engine

                    Session = sessionmaker(bind=engine)
    
                    return Session



                #  ./classes/user
                from dataclasses import dataclass
                from sqlalchemy import Column as ORMColumn
                from sqlalchemy import String as ORMString
                from sqlalchemy import Integer as ORMInteger
                from sqlalchemy import Boolean as ORMBoolean

                from services.database import db


                # On dÃ©clare le schema pour les utilisateurs
                class UserRow(db.Base):
                    __tablename__ = 'user'

                    id = ORMColumn(ORMInteger, primary_key=True)
                    username = ORMColumn(ORMString, nullable=False)
                    password = ORMColumn(ORMString, nullable=False)
                    email = ORMColumn(ORMString, nullable=False)
                    confirmed = ORMColumn(ORMBoolean, default=False)


                # On crÃ©e une dataclass pour les utilisateurs
                @dataclass
                class User:
                    id:int
                    username:str
                    password:str
                    email:str
                    confirmed:bool

                    # MÃ©thode pour avoir un User depuis la DB
                    @classmethod
                    def from_row(cls, row:UserRow):
                        return User(
                            id=row.id,
                            username=row.username,
                            password=row.password,
                            email=row.email,
                            confirmed=row.confirmed
                        )
    
                    # ... et pour l'avoir avec juste l'id
                    @classmethod
                    def from_row_id(cls, id:int):
                        with db.create_session().begin() as db_session:
                            user_row = db_session.query(UserRow).get(id)
                            user = User.from_row(user_row)
                            db_session.close()
        
                        return user
    
                    # MÃ©thode pour convertir un User pour la DB
                    def to_row(self) -&gt; UserRow:
                        return UserRow(
                            id=self.id,
                            username=self.username,
                            password=self.password,
                            email=self.email,
                            confirmed=self.confirmed
                        )
    
                    # ... et pour l'enregistrer
                    def store_row(self) -&gt; int:
                        user_row = self.to_row()

                        with db.create_session().begin() as db_session:
                            db_session.add(user_row)
                            db_session.flush()
                            id = user_row.id
        
                        return id
        
                    </code></pre>
            </section>


            <section>
                <p>Et ben, mainteant c'est Ã  vous !</p>

                <p><small>Vous pouvez vous lancer dans le wrappin' up de ce cours pour crÃ©er votre base de dÃ©veloppement Flask.</small></p>

                <p><small>Maintenant, comme promis, une liste de ressources pour votre dÃ©collage avec Flask :

                    <br><a href="https://pythonhosted.org/Flask-Mail/">Flask Mail</a>
                    <br><a href="https://flask-jwt-extended.readthedocs.io/en/stable/">Flask JWT extended</a>
                    <br><a href="https://docs.sqlalchemy.org/14/orm/tutorial.html">SQLAlchemy</a>
                    <br><a href="https://flask.palletsprojects.com/en/2.0.x/deploying/">Flask deploy</a></small></p>


                <p><small>Pour des projets suuuuuuper complexes :

                    <br><a href="https://python-telegram-bot.readthedocs.io/en/stable/">Python + Telegram</a>
                    <br><a href="https://flask-socketio.readthedocs.io/en/latest/">Flask-SocketIO</a>
                    <br><a href="https://docs.celeryproject.org/en/stable/index.html">Celery</a>
                    <br><a href="https://flower.readthedocs.io/">Flower (Celery monitor)</a>
                    <br><a href="https://github.com/miguelgrinberg/flask-celery-example">Celery + Flask</a>
                    <br><a href="https://scrapy.org/">Scrapy</a>
                    <br><a href="https://codeburst.io/running-scrapy-in-celery-tasks-d81e159921ea">Scrapy + Celery</a>
                    <br><a href="https://github.com/clemfromspace/scrapy-selenium">Scrapy + Selenium</a></small></p>
            </section>

        </section>

    </div>
    	</div>
        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                hash: true,
                parallaxBackgroundImage: 'https://background-tiles.com/overview/black/patterns/large/1035.png',
                parallaxBackgroundSize: '300px 300px',
                parallaxBackgroundHorizontal: 200,
                parallaxBackgroundVertical: 50,

                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
            });
        </script>
    </body>
</html>